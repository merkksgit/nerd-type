<!doctype html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-R80KP2H5BL"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-R80KP2H5BL");
    </script>
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="//kit.fontawesome.com" />

    <!-- Prefetch other pages (from pages folder) -->
    <link rel="prefetch" href="../index.html" />
    <link rel="prefetch" href="./game.html" />
    <link rel="prefetch" href="./chart.html" />
    <link rel="prefetch" href="./achievements.html" />
    <link rel="prefetch" href="./info.html" />
    <link rel="prefetch" href="./terms.html" />
    <link rel="prefetch" href="./archive.html" />
    <title>NerdType | Global Scoreboard</title>
    <link
      rel="icon"
      type="image/png"
      href="../images/logo-no-keyboard-blue-bg-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      type="image/png"
      href="../images/logo-no-keyboard-blue-bg-192x192.png"
      sizes="192x192"
    />
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/globalscoreboard.css" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script
      src="https://kit.fontawesome.com/fc21fca839.js"
      crossorigin="anonymous"
    ></script>
    <!-- Firebase v9 SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        query,
        orderByChild,
        limitToLast,
        get,
        equalTo,
        set,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // Make Firebase modules available globally
      window.firebaseModules = {
        initializeApp,
        getDatabase,
        ref,
        push,
        query,
        orderByChild,
        limitToLast,
        get,
        equalTo,
        set,
        remove,
      };

      // Initialize Firebase using the config file
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof window.initializeFirebaseApp === "function") {
          window.initializeFirebaseApp(window.firebaseModules);
        }
      });
    </script>

    <!-- Firebase config file -->
    <script src="../js/firebase-config.js"></script>
  </head>
  <!-- Content -->
  <body class="d-flex flex-column h-100">
    <div class="container-fluid flex-grow-1">
      <header class="d-flex justify-content-start align-items-center">
        <a href="../index.html">
          <img
            id="header-logo"
            src="../images/logo-text-no-keyboard.png"
            alt="NerdType Logo"
          />
        </a>
        <a href="../index.html">
          <img
            id="header-logo-no-text"
            src="../images/mobile-header-logo-v2.png"
            alt="NerdType Logo"
          />
        </a>
      </header>
      <nav class="navbar navbar-dark navbar-expand">
        <div class="container-fluid">
          <div class="navbar-collapse justify-content-center" id="mainmenu">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="../index.html"
                  ><i class="fa-solid fa-house"></i
                ></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./game.html"
                  ><i class="fa-solid fa-keyboard"></i
                ></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./chart.html"
                  ><i class="fa-solid fa-chart-line"></i
                ></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./achievements.html"
                  ><i class="fa-solid fa-trophy"></i
                ></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="current" href="./globalscoreboard.html"
                  ><i class="fa-solid fa-medal"></i
                ></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./info.html"
                  ><i class="fa-solid fa-circle-info"></i
                ></a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- Main Content -->
      <main class="container-fluid py-4">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-10 col-xl-8">
            <!-- Page Header -->
            <div class="text-center mb-4 mt-5">
              <h1 class="page-title mb-3">
                <i class="fa-solid fa-globe me-3"></i>GLOBAL SCOREBOARD
              </h1>
              <p class="lead page-subtitle mb-5">
                Compete with nerds from around the world. See where you rank
                among the fastest typists!
              </p>
            </div>

            <!-- Controls -->
            <div class="d-flex justify-content-center gap-3 mb-4">
              <button id="refreshScoresBtn" class="btn btn-primary">
                <i class="fa-solid fa-sync-alt me-2"></i>Refresh
              </button>
              <div class="dropdown">
                <button
                  class="btn btn-outline-primary dropdown-toggle"
                  type="button"
                  id="modeFilter"
                  data-bs-toggle="dropdown"
                >
                  <i class="fa-solid fa-filter me-2"></i>All Modes
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="#" data-mode="all"
                      >All Modes</a
                    >
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" data-mode="Classic Mode"
                      >Classic Mode</a
                    >
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" data-mode="Custom Mode"
                      >Custom Mode</a
                    >
                  </li>
                </ul>
              </div>
            </div>

            <!-- Connection Status -->
            <div
              id="connectionStatus"
              class="alert alert-info text-center"
              style="display: none"
            >
              Connecting to global database...
            </div>

            <!-- Loading/Status -->
            <div
              id="loadingStatus"
              class="text-center mb-4"
              style="display: none"
            >
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-secondary">Loading global scores...</p>
            </div>

            <!-- Error Message -->
            <div
              id="errorMessage"
              class="alert alert-danger text-center"
              style="display: none"
            >
              <i class="fa-solid fa-exclamation-triangle me-2"></i>
              <span id="errorText"
                >Failed to load scores. Please try again.</span
              >
            </div>

            <!-- Scoreboard -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title mb-0">
                  <i class="fa-solid fa-trophy me-2"></i>
                  <span id="scoreboardTitle">Top 20 Global Scores</span>
                </h3>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-dark table-hover mb-0">
                    <thead>
                      <tr>
                        <th scope="col" class="text-center" style="width: 80px">
                          Rank
                        </th>
                        <th scope="col">Player</th>
                        <th scope="col" class="text-center">Score</th>
                        <th scope="col" class="text-center">WPM</th>
                        <th scope="col" class="text-center">Accuracy</th>
                        <th
                          scope="col"
                          class="text-center d-none d-md-table-cell"
                        >
                          Mode
                        </th>
                        <th
                          scope="col"
                          class="text-center d-none d-lg-table-cell"
                        >
                          Language
                        </th>
                        <th
                          scope="col"
                          class="text-center d-none d-lg-table-cell"
                        >
                          Date
                        </th>
                      </tr>
                    </thead>
                    <tbody id="scoresTableBody">
                      <tr>
                        <td colspan="8" class="text-center py-5 empty-state">
                          No scores loaded yet. Click "Refresh" to load global
                          scores.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Stats Section -->
            <div class="row mt-4 mb-5">
              <div class="col-md-6">
                <div class="card stats-card">
                  <div class="card-body text-center">
                    <h5 class="card-title info-title">
                      <i class="fa-solid fa-users me-2"></i>Total Players
                    </h5>
                    <p class="display-6 stats-number mb-0" id="totalPlayers">
                      -
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card stats-card">
                  <div class="card-body text-center">
                    <h5 class="card-title info-title">
                      <i class="fa-solid fa-gamepad me-2"></i>Total Games
                    </h5>
                    <p class="display-6 stats-number mb-0" id="totalGames">-</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Info Section -->
            <div class="mt-4 p-4 info-section">
              <h5 class="info-title mb-3">
                <i class="fa-solid fa-info-circle me-2"></i>How Rankings Work
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <p class="text-secondary mb-2">
                    <strong class="info-label">Score Calculation:</strong> Based
                    on WPM, accuracy, time remaining, and difficulty settings.
                  </p>
                  <p class="text-secondary mb-2">
                    <strong class="info-label">Real-time Updates:</strong>
                    Scores update automatically as players complete games.
                  </p>
                  <p class="text-secondary mb-3">
                    <strong class="info-label">Privacy First:</strong>
                    Participation in global leaderboards is entirely optional.
                    You can control your data sharing preferences through the
                    Settings panel by toggling "Share game data for
                    leaderboards" on or off.
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="text-secondary mb-2">
                    <strong class="info-label">Fair Play:</strong> Different
                    game modes are tracked separately. All word sets compete in
                    the same global leaderboard.
                  </p>
                  <p class="text-secondary mb-2">
                    <strong class="info-label">Global Competition:</strong>
                    Compete with typists from around the world!
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto p-3">
      <div class="container-fluid">
        <div class="row">
          <div
            class="col-12 d-flex flex-column flex-md-row justify-content-center align-items-center gap-2 gap-md-4"
          >
            <span id="versionInfo" class="footer-text"></span>
            <span class="d-flex align-items-center footer-text">
              <i class="bi bi-c-circle me-2"></i>
              <script>
                document.write(new Date().getFullYear());
              </script>
              ERKKA LEPPÃ„NEN
            </span>
            <div class="d-flex gap-4 mt-2 mt-md-0">
              <a
                href="https://github.com/merkksgit/nerd-type"
                target="_blank"
                class="text-decoration-none social-link"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-template='<div class="tooltip" role="tooltip"><div class="tooltip-inner"></div></div>'
                title="GitHub"
              >
                <i class="bi bi-github"></i>
              </a>
              <a
                href="https://www.instagram.com/nerdtypegame/"
                target="_blank"
                class="text-decoration-none social-link"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-template='<div class="tooltip" role="tooltip"><div class="tooltip-inner"></div></div>'
                title="Instagram"
              >
                <i class="bi bi-instagram"></i>
              </a>
              <a
                href="./contact.html"
                class="text-decoration-none social-link"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-template='<div class="tooltip" role="tooltip"><div class="tooltip-inner"></div></div>'
                title="Contact"
              >
                <i class="bi bi-envelope"></i>
              </a>
              <a
                href="./terms.html"
                class="text-decoration-none social-link"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-template='<div class="tooltip" role="tooltip"><div class="tooltip-inner"></div></div>'
                title="Terms of Use"
              >
                <i class="bi bi-file-text"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script src="../js/version.js"></script>
    <script src="../js/username.js"></script>
    <script src="../js/contact.js"></script>
    <script src="../js/keyboard-nav.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- Global Scoreboard JavaScript -->
    <script>
      let currentMode = "all";
      let allScores = [];

      // Wait for Firebase to be ready
      document.addEventListener("DOMContentLoaded", function () {
        // Set up event listeners
        setupEventListeners();

        // Load scores when Firebase is ready
        setTimeout(() => {
          if (typeof window.getTopScores === "function") {
            loadGlobalScores();
          } else {
            showError("Firebase not initialized. Please refresh the page.");
          }
        }, 2000);
      });

      function setupEventListeners() {
        // Refresh button
        document
          .getElementById("refreshScoresBtn")
          .addEventListener("click", loadGlobalScores);

        // Mode filter dropdown
        document.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();
            const mode = this.dataset.mode;
            const modeText = this.textContent;

            currentMode = mode;
            document.getElementById("modeFilter").innerHTML =
              `<i class="fa-solid fa-filter me-2"></i>${modeText}`;

            filterScores();
          });
        });
      }

      async function loadGlobalScores() {
        showLoading(true);
        hideError();

        try {
          // Get all scores from Firebase
          if (typeof window.getTopScores !== "function") {
            throw new Error("Firebase functions not available");
          }

          // Get top 20 scores instead of 10
          const scores = await getAllScores();
          allScores = scores;

          updateStats(scores);
          filterScores();
        } catch (error) {
          console.error("Error loading global scores:", error);
          showError("Failed to load global scores. Please try again.");
        } finally {
          showLoading(false);
        }
      }

      async function getAllScores() {
        const firebaseModules = window.firebaseModules;
        if (!firebaseModules) {
          throw new Error("Firebase modules not available");
        }

        const { getDatabase, ref, query, orderByChild, limitToLast, get } =
          firebaseModules;
        const database = getDatabase();

        const scoresRef = ref(database, "scores");

        // First, get ALL scores to count total games
        const allScoresSnapshot = await get(scoresRef);
        let totalGamesCount = 0;
        let allScoresForStats = [];

        if (allScoresSnapshot.exists()) {
          allScoresSnapshot.forEach((childSnapshot) => {
            allScoresForStats.push(childSnapshot.val());
          });
          totalGamesCount = allScoresForStats.length;
        }

        // Store total count globally for stats
        window.totalGamesPlayed = totalGamesCount;
        window.allScoresForStats = allScoresForStats;

        // Then get top scores for display
        const topScoresQuery = query(
          scoresRef,
          orderByChild("score"),
          limitToLast(50),
        );
        const topSnapshot = await get(topScoresQuery);

        if (topSnapshot.exists()) {
          const topScores = [];
          topSnapshot.forEach((childSnapshot) => {
            topScores.push(childSnapshot.val());
          });
          return topScores.reverse().slice(0, 20);
        }
        return [];
      }

      function filterScores() {
        let filteredScores = allScores;

        if (currentMode !== "all") {
          filteredScores = allScores.filter(
            (score) => score.mode === currentMode,
          );
        }

        displayScores(filteredScores);

        // Update title
        const title =
          currentMode === "all"
            ? "Top 20 Global Scores"
            : `Top 20 ${currentMode} Scores`;
        document.getElementById("scoreboardTitle").textContent = title;
      }

      function displayScores(scores) {
        const tbody = document.getElementById("scoresTableBody");

        if (scores.length === 0) {
          tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center py-5 empty-state">
          No scores found for the selected filter.
        </td>
      </tr>
    `;
          return;
        }

        tbody.innerHTML = "";

        scores.forEach((score, index) => {
          const rank = index + 1;
          const rankIcon = getRankIcon(rank);
          const date = new Date(
            score.date || score.timestamp,
          ).toLocaleDateString("en-GB");

          const row = document.createElement("tr");

          // Check if this is admin user
          const isAdmin =
            score.username && score.username.toLowerCase() === "merkks";

          // Add special styling for admin and top performers
          if (isAdmin) {
            row.className = "admin-row";
          } else if (rank === 1) {
            row.className = "champion";
          } else if (rank <= 3) {
            row.className = "top-performer";
          }

          // Determine rank class for styling
          let rankClass = "rank-cell";
          if (rank === 1) rankClass += " rank-1";
          else if (rank === 2) rankClass += " rank-2";
          else if (rank === 3) rankClass += " rank-3";
          else if (rank <= 10) rankClass += " rank-top10";

          // Format username with admin styling if needed
          const usernameDisplay = isAdmin
            ? `<strong class="admin-username">${score.username || "Anonymous"}</strong>`
            : `<strong class="username-cell">${score.username || "Anonymous"}</strong>`;

          row.innerHTML = `
      <td class="text-center ${rankClass}">
        ${rankIcon} ${rank}
      </td>
      <td>
        ${usernameDisplay}
      </td>
      <td class="text-center">
        <span class="badge score-badge">${score.score || 0}</span>
      </td>
      <td class="text-center wpm-cell">${score.wpm || 0}</td>
      <td class="text-center accuracy-cell">${score.accuracy || "N/A"}</td>
      <td class="text-center d-none d-md-table-cell mode-cell">
        ${score.mode || "Unknown"}
      </td>
      <td class="text-center d-none d-lg-table-cell meta-cell">
        ${score.wordList || "Unknown"}
      </td>
      <td class="text-center d-none d-lg-table-cell meta-cell">
        ${date}
      </td>
    `;

          tbody.appendChild(row);
        });
      }
      // add rank icon here if you feel like it
      function getRankIcon(rank) {
        return "";
      }

      function updateStats(scores) {
        // Use all scores for accurate stats, not just displayed ones
        const allScores = window.allScoresForStats || scores;
        const totalGames = window.totalGamesPlayed || scores.length;

        const uniquePlayers = new Set(allScores.map((score) => score.username))
          .size;
        document.getElementById("totalPlayers").textContent = uniquePlayers;
        document.getElementById("totalGames").textContent = totalGames;
      }

      function showLoading(show) {
        const loadingDiv = document.getElementById("loadingStatus");
        loadingDiv.style.display = show ? "block" : "none";
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        const errorText = document.getElementById("errorText");
        errorText.textContent = message;
        errorDiv.style.display = "block";
      }

      function hideError() {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.style.display = "none";
      }
    </script>
  </body>
</html>
