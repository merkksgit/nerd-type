<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NerdType - High Scores Test</title>
    <style>
      body {
        background-color: #1a1b26;
        color: #c0caf5;
        font-family: "Courier New", monospace;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #7aa2f7;
        margin-bottom: 30px;
      }

      .controls {
        text-align: center;
        margin-bottom: 20px;
      }

      button {
        background-color: #7aa2f7;
        color: #1a1b26;
        border: none;
        padding: 10px 20px;
        margin: 0 10px;
        border-radius: 5px;
        cursor: pointer;
        font-family: inherit;
        font-weight: bold;
      }

      button:hover {
        background-color: #9ece6a;
      }

      .status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }

      .status.success {
        background-color: rgba(158, 206, 106, 0.2);
        color: #9ece6a;
      }

      .status.error {
        background-color: rgba(247, 118, 142, 0.2);
        color: #f7768e;
      }

      .status.loading {
        background-color: rgba(187, 154, 247, 0.2);
        color: #bb9af7;
      }

      .scores-container {
        background-color: #24283b;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .score-item {
        padding: 10px;
        margin: 5px 0;
        background-color: #1f2335;
        border-radius: 5px;
        border-left: 3px solid #7aa2f7;
      }

      .rank {
        font-size: 18px;
        font-weight: bold;
      }

      .username {
        color: #9ece6a;
        font-weight: bold;
      }

      .score {
        color: #ff9e64;
      }

      .wpm {
        color: #7dcfff;
      }

      .accuracy {
        color: #bb9af7;
      }

      .meta {
        color: #565f89;
        font-size: 12px;
      }

      .test-section {
        background-color: #24283b;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      input {
        background-color: #1f2335;
        color: #c0caf5;
        border: 1px solid #565f89;
        padding: 8px;
        border-radius: 3px;
        font-family: inherit;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üèÜ NerdType High Scores Test</h1>

      <div class="test-section">
        <h3>üß™ Firebase Connection Test</h3>
        <div id="connectionStatus" class="status loading">
          Testing connection...
        </div>
        <button onclick="testConnection()">Test Connection</button>

        <h4>Add Test Score:</h4>
        <input
          type="text"
          id="testUsername"
          placeholder="Username"
          value="TestUser"
        />
        <input type="number" id="testScore" placeholder="Score" value="1000" />
        <input type="number" id="testWpm" placeholder="WPM" value="50" />
        <input
          type="text"
          id="testAccuracy"
          placeholder="Accuracy"
          value="95%"
        />
        <button onclick="addTestScore()">Add Test Score</button>
      </div>

      <div class="controls">
        <button onclick="loadHighScores()">üîÑ Load High Scores</button>
        <button onclick="clearScores()">üóëÔ∏è Clear Test Scores</button>
      </div>

      <div id="status" class="status loading">Ready to load scores...</div>

      <div class="scores-container">
        <h2>üåç Global High Scores</h2>
        <div id="highScores">
          <div class="score-item">
            No scores loaded yet. Click "Load High Scores" to fetch data.
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase v9 SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        query,
        orderByChild,
        limitToLast,
        get,
        remove,
        set,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD40pIb2RoLbGYVE7mpbS5eN4rcsP742gE",
        authDomain: "nerdtype-leaderboard.firebaseapp.com",
        databaseURL:
          "https://nerdtype-leaderboard-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "nerdtype-leaderboard",
        storageBucket: "nerdtype-leaderboard.firebasestorage.app",
        messagingSenderId: "880144823417",
        appId: "1:880144823417:web:c567724792c6e37647d0a8",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      console.log("‚úÖ Firebase initialized");

      // Test connection
      async function testConnectionInternal() {
        const statusDiv = document.getElementById("connectionStatus");
        try {
          statusDiv.textContent = "Testing connection...";
          statusDiv.className = "status loading";

          const testRef = ref(database, "connectionTest");
          await set(testRef, {
            message: "Connection test",
            timestamp: Date.now(),
          });

          statusDiv.textContent = "‚úÖ Connected to Firebase successfully!";
          statusDiv.className = "status success";

          // Clean up
          await remove(testRef);
        } catch (error) {
          console.error("Connection test failed:", error);
          statusDiv.textContent = `‚ùå Connection failed: ${error.message}`;
          statusDiv.className = "status error";
        }
      }

      // Load high scores
      async function loadHighScoresInternal() {
        const statusDiv = document.getElementById("status");
        const scoresDiv = document.getElementById("highScores");

        try {
          statusDiv.textContent = "Loading high scores...";
          statusDiv.className = "status loading";

          const scoresRef = ref(database, "scores");
          const topScoresQuery = query(
            scoresRef,
            orderByChild("score"),
            limitToLast(10),
          );
          const snapshot = await get(topScoresQuery);

          if (snapshot.exists()) {
            const scores = [];
            snapshot.forEach((childSnapshot) => {
              scores.push(childSnapshot.val());
            });

            // Sort highest to lowest
            scores.reverse();

            scoresDiv.innerHTML = "";

            if (scores.length === 0) {
              scoresDiv.innerHTML =
                '<div class="score-item">No scores found.</div>';
            } else {
              scores.forEach((score, index) => {
                const rank = index + 1;
                const rankEmoji =
                  rank === 1
                    ? "ü•á"
                    : rank === 2
                      ? "ü•à"
                      : rank === 3
                        ? "ü•â"
                        : "üèÜ";

                const date = new Date(
                  score.date || score.timestamp,
                ).toLocaleDateString();

                const scoreItem = document.createElement("div");
                scoreItem.className = "score-item";
                scoreItem.innerHTML = `
                                <div class="rank">${rankEmoji} #${rank}</div>
                                <div>
                                    <span class="username">${score.username || "Anonymous"}</span> | 
                                    <span class="score">Score: ${score.score || 0}</span> | 
                                    <span class="wpm">WPM: ${score.wpm || 0}</span> | 
                                    <span class="accuracy">Accuracy: ${score.accuracy || "N/A"}</span>
                                </div>
                                <div class="meta">
                                    ${score.mode || "Unknown Mode"} | ${score.wordList || "Unknown"} | ${date}
                                </div>
                            `;
                scoresDiv.appendChild(scoreItem);
              });
            }

            statusDiv.textContent = `‚úÖ Loaded ${scores.length} high scores`;
            statusDiv.className = "status success";
          } else {
            scoresDiv.innerHTML =
              '<div class="score-item">No scores found in database.</div>';
            statusDiv.textContent = "üìä No scores in database yet";
            statusDiv.className = "status success";
          }
        } catch (error) {
          console.error("Error loading scores:", error);
          statusDiv.textContent = `‚ùå Error loading scores: ${error.message}`;
          statusDiv.className = "status error";
          scoresDiv.innerHTML =
            '<div class="score-item">Error loading scores.</div>';
        }
      }

      // Add test score
      async function addTestScoreInternal() {
        const statusDiv = document.getElementById("status");

        try {
          const username =
            document.getElementById("testUsername").value || "TestUser";
          const score =
            parseInt(document.getElementById("testScore").value) || 1000;
          const wpm = parseInt(document.getElementById("testWpm").value) || 50;
          const accuracy =
            document.getElementById("testAccuracy").value || "95%";

          const testScore = {
            username: username,
            score: score,
            wpm: wpm,
            accuracy: accuracy,
            mode: "Test Mode",
            wordList: "test",
            date: new Date().toISOString(),
            timestamp: Date.now(),
          };

          statusDiv.textContent = "Adding test score...";
          statusDiv.className = "status loading";

          const scoresRef = ref(database, "scores");
          await push(scoresRef, testScore);

          statusDiv.textContent = "‚úÖ Test score added successfully!";
          statusDiv.className = "status success";

          // Auto-reload scores
          setTimeout(loadHighScoresInternal, 1000);
        } catch (error) {
          console.error("Error adding test score:", error);
          statusDiv.textContent = `‚ùå Error adding score: ${error.message}`;
          statusDiv.className = "status error";
        }
      }

      // Clear all scores (for testing)
      async function clearScoresInternal() {
        const statusDiv = document.getElementById("status");

        if (
          !confirm(
            "Are you sure you want to clear ALL scores? This cannot be undone!",
          )
        ) {
          return;
        }

        try {
          statusDiv.textContent = "Clearing scores...";
          statusDiv.className = "status loading";

          const scoresRef = ref(database, "scores");
          await remove(scoresRef);

          statusDiv.textContent = "‚úÖ All scores cleared";
          statusDiv.className = "status success";

          // Reload to show empty state
          setTimeout(loadHighScoresInternal, 500);
        } catch (error) {
          console.error("Error clearing scores:", error);
          statusDiv.textContent = `‚ùå Error clearing scores: ${error.message}`;
          statusDiv.className = "status error";
        }
      }

      // Make functions available globally
      window.testConnection = testConnectionInternal;
      window.loadHighScores = loadHighScoresInternal;
      window.addTestScore = addTestScoreInternal;
      window.clearScores = clearScoresInternal;

      // Auto-test connection on load
      setTimeout(testConnectionInternal, 1000);
    </script>
  </body>
</html>
